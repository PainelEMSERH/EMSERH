generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  regional
  unidade
  operador
}

enum StatusColaborador {
  ativo
  inativo
}

enum StatusPendencia {
  aberta
  atendida
  cancelada
}

enum EscopoMeta {
  regional
  unidade
}

enum PeriodoMeta {
  mensal
  anual
}

enum IndicadorMeta {
  entregas
  itens
  colab_atendidos
}

enum EntidadeArquivo {
  ficha_epi
}

model Regional {
  id       String   @id @default(cuid())
  nome     String
  sigla    String   @unique
  unidades Unidade[]
  metas    Meta[]
  usuarios Usuario[]
}

model Unidade {
  id            String   @id @default(cuid())
  regionalId    String
  regional      Regional @relation(fields: [regionalId], references: [id])
  nome          String
  sigla         String
  estoque       Estoque[]
  colaboradores Colaborador[]
  entregas      Entrega[]
  metas         Meta[]
  usuarios      Usuario[]

  @@unique([regionalId, sigla])
  @@index([regionalId])
  @@index([sigla])
}

model Funcao {
  id            String  @id @default(cuid())
  nome          String  @unique
  descricao     String?
  kits          Kit[]
  colaboradores Colaborador[]
}

model Kit {
  id        String  @id @default(cuid())
  funcaoId  String  @unique
  funcao    Funcao  @relation(fields: [funcaoId], references: [id])
  nome      String
  descricao String?
  itens     KitItem[]
}

model KitItem {
  kitId      String
  itemId     String
  quantidade Int
  kit        Kit   @relation(fields: [kitId], references: [id])
  item       Item  @relation(fields: [itemId], references: [id])

  @@id([kitId, itemId])
}

model Item {
  id            String   @id @default(cuid())
  nome          String
  categoria     String
  ca            String?
  descricao     String?
  unidadeMedida String
  validadeDias  Int?
  ativo         Boolean  @default(true)
  estoque       Estoque[]
  entregaItens  EntregaItem[]
  pendencias    Pendencia[]

  @@index([categoria])
  @@unique([nome, categoria])
}

model Estoque {
  id         String  @id @default(cuid())
  unidadeId  String
  itemId     String
  quantidade Int     @default(0)
  minimo     Int     @default(0)
  maximo     Int?
  unidade    Unidade @relation(fields: [unidadeId], references: [id])
  item       Item    @relation(fields: [itemId], references: [id])

  @@unique([unidadeId, itemId])
  @@index([unidadeId])
  @@index([itemId])
}

model Colaborador {
  id          String  @id @default(cuid())
  unidadeId   String
  funcaoId    String
  nome        String
  matricula   String
  email       String?
  telefone    String?
  status      StatusColaborador @default(ativo)
  unidade     Unidade @relation(fields: [unidadeId], references: [id])
  funcao      Funcao  @relation(fields: [funcaoId], references: [id])
  entregas    Entrega[]
  pendencias  Pendencia[]

  @@unique([unidadeId, matricula])
  @@index([funcaoId])
}

model Entrega {
  id                String   @id @default(cuid())
  unidadeId         String
  colaboradorId     String
  data              DateTime @default(now())
  responsavelUserId String
  observacao        String?

  unidade     Unidade    @relation(fields: [unidadeId], references: [id])
  colaborador Colaborador @relation(fields: [colaboradorId], references: [id])
  itens       EntregaItem[]
  pendencias  Pendencia[]
  arquivos    Arquivo[]

  @@index([unidadeId, data])
  @@index([colaboradorId])
}

model EntregaItem {
  entregaId     String
  itemId        String
  qtdSolicitada Int
  qtdEntregue   Int
  qtdPendente   Int
  validadeLote  DateTime?
  lote          String?

  entrega Entrega @relation(fields: [entregaId], references: [id])
  item    Item    @relation(fields: [itemId], references: [id])

  @@id([entregaId, itemId])
}

model Pendencia {
  id            String @id @default(cuid())
  entregaId     String?
  colaboradorId String
  itemId        String
  quantidade    Int
  status        StatusPendencia @default(aberta)
  abertaEm      DateTime @default(now())
  prazo         DateTime?
  atendidaEm    DateTime?

  entrega     Entrega?    @relation(fields: [entregaId], references: [id])
  colaborador Colaborador @relation(fields: [colaboradorId], references: [id])
  item        Item        @relation(fields: [itemId], references: [id])

  @@index([status])
  @@index([colaboradorId])
  @@index([itemId])
}

model Meta {
  id             String @id @default(cuid())
  escopo         EscopoMeta
  regionalId     String?
  unidadeId      String?
  periodo        PeriodoMeta
  ano            Int
  mes            Int?
  indicador      IndicadorMeta
  valorMeta      Int
  valorRealizado Int      @default(0)
  atualizadoEm   DateTime @updatedAt

  regional       Regional? @relation(fields: [regionalId], references: [id])
  unidade        Unidade?  @relation(fields: [unidadeId], references: [id])

  @@index([escopo, periodo, ano, mes])
  @@index([regionalId])
  @@index([unidadeId])
  @@unique([escopo, regionalId, unidadeId, periodo, ano, mes, indicador])
}

model Usuario {
  id          String @id @default(cuid())
  clerkUserId String @unique
  nome        String
  email       String @unique
  role        Role
  regionalId  String?
  unidadeId   String?
  ativo       Boolean @default(true)

  regional    Regional? @relation(fields: [regionalId], references: [id])
  unidade     Unidade?  @relation(fields: [unidadeId], references: [id])

  @@index([role])
}

model Arquivo {
  id           String @id @default(cuid())
  entidade     EntidadeArquivo
  entidadeId   String
  driveFileId  String
  driveUrl     String
  nomeArquivo  String
  criadoEm     DateTime @default(now())

  entrega      Entrega? @relation(fields: [entidadeId], references: [id])

  @@index([entidade, entidadeId])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String
  action    String
  entity    String
  entityId  String
  diff      Json?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
}
